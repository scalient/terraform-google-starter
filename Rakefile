# frozen_string_literal: true

# Copyright 2025 Scalient LLC
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License. You may obtain a copy of
# the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.

require "json"
require "pathname"

receipts = {}

[
  "prerequisites",
  "stage_bootstrap",
].each do |name|
  receipts[name] = Pathname.new("receipts/#{name}")
end

user_tfvars = Pathname.new("terraform.tfvars")
prerequisites_tfvars = Pathname.new("00_prerequisites.auto.tfvars.json")
stage_bootstrap_dir = Pathname.new("modules/0-bootstrap")

task "prerequisites" => receipts["prerequisites"]

file receipts["prerequisites"] => user_tfvars do
  # Potentially rewrite the lock file to include cross-architecture providers.
  sh "terraform", "init"
  sh "terraform", "providers", "lock",
     "-platform", "linux_amd64",
     "-platform", "linux_arm64",
     "-platform", "darwin_amd64",
     "-platform", "darwin_arm64"
  sh "terraform", "apply"

  parent_read, child_write = IO.pipe

  heredoc_content = <<EOS
.resources[] |
select(
  .module == "module.prerequisites.module.administration_project.module.project-factory" and
    .type == "google_project"
) |
.instances[0].attributes.project_id
EOS

  sh "jq", heredoc_content, "--", "terraform.tfstate", out: child_write

  child_write.close
  administration_project_id = JSON.parse(parent_read.read)

  child_read, parent_write = IO.pipe
  parent_read, child_write = IO.pipe

  Thread.new do
    heredoc_content = <<EOS
jsonencode(var.groups)
EOS
    parent_write.write(heredoc_content)
    parent_write.close
  end

  sh "terraform", "console", "-var-file", "terraform.tfvars", in: child_read, out: child_write

  child_write.close

  # First strip away the double quotes, and then parse the JSON.
  groups_json = JSON.parse(JSON.parse(parent_read.read))
  # Inject the detected administration project id as the billing project for the foundation bootstrap stage.
  groups_json["billing_project"] = administration_project_id

  prerequisites_tfvars.open("wb") do |f|
    f.write(JSON.dump({groups: groups_json}))
  end

  touch receipts["prerequisites"]
end

task "bootstrap" => receipts["stage_bootstrap"]

file receipts["stage_bootstrap"] => receipts["prerequisites"] do
  Dir.chdir(stage_bootstrap_dir) do
    sh "terraform", "init"
    # Apply the top-level tfvars, and then override that with the autogenerated one from the `prerequisites` target.
    sh "terraform", "apply",
       "-var-file", "../../terraform.tfvars",
       "-var-file", prerequisites_tfvars.relative_path_from(stage_bootstrap_dir).to_s
  end

  touch receipts["stage_bootstrap"]
end
